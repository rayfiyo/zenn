---
title: "WSLで外のネットワークにアクセスできないときの解決策" # 記事のタイトル
emoji: "💡" # 1文字
type: "tech" # tech: 技術記事 / idea: アイデア記事
topics: ["WSL", "WSL2", "トラブルシューティング"] # ["markdown", "rust", "aws"]のように５つまで
published: true # falseで下書き
published_at: 2023-12-06 18:00 # 過去・未来の日時

# https://zenn.dev/zenn/articles/zenn-cli-guide
# https://zenn.dev/zenn/articles/markdown-guide
---

# 概要

- 「 WSL がインターネットに繋がらない」の分割と解決
- 当記事でも解決できない可能性を考慮し，役たちそうな情報を[最後にまとめた](#解決できないとき用の記事)

# 背景

- WSL2 でネットワーク関係の不具合がよくあるが，情報が少なかったため

# 対象読者

- WSL2 利用者
- 未来の自分

---

# 本論

各問題解決に関する文献は，この記事の最後にまとめて述べている．（→ [関連文献](#関連文献)）
また，以降で WSL と表記したときは WSL2 に限定し，Windows は Windows11 を想定する．
さらに，再起動などは全て試行済みだとする．

## ネットワークの切り分け

次などを試すことで，原因の切り分けを行う．

- 別のアクセスポイント
- 別の接続方法（テザリング，テザリング以外，無線，有線，…）

もし，成功する組み合わせがあるならば，これ以降の情報は役に立たない可能性が高い．

:::details 例

例えば，モバイルデータ通信を利用したテザリングで，
アクセスポイント名設定（APNタイプ）や，モバイル側のDNS設定が不適切な場合など，
これ以降に述べる Windows 機の設定が原因ではない可能性があるということ．

:::

## Windows 側の設定

「Windows の機能の有効化または無効化」を起動（コントロール パネル\プログラム\プログラムと機能 から，Windows の検索 から など）し，以下の３つを有効化する．

- Linux 用 Windows サブシステム
- Windows ハイパーバイザー プラットフォーム
- 仮想マシン プラットフォーム

:::message

- Windows ハイパーバイザー プラットフォーム の有効化は他のVMとの不具合が見られる．[\*1](#1)
- Insider Preview Build 20246 以降は `wsl --install` で自動で有効化される．[\*1](#1)

:::

## 命名解決に失敗している場合

外部へアクセスすることはできるが，命名解決に（DNS 関係で）失敗している．
本記事では，WSL側 で問題が起きている（Windows側 は問題ない）場合の解決策を以下の述べる．
その他の場合も検索で出て来やすい不具合である．

### この場合の特徴

この場合は，WSL で以下を実行すると，上のコマンドは失敗するが，下のコマンドは成功する という結果が得られる．

```sh:wsl
ping google.com
ping 8.8.8.8
```

PowerShell でも同じコマンドを実行したとき，両行が成功する場合は，WSL側 の問題である．
そうではない場合は，WSL ではなく Windows側 の問題である
．
:::message

```sh:wsl
$ ping google.com
PING google.com (142.250.206.206) 56(84) bytes of data.
```

のような出力が出て失敗する（何も出力されなくなる）場合は，ローカルのDNSでの命名解決は成功している．
つまり，[命名解決に失敗している場合](#命名解決に失敗している場合) の項目は関係ない可能性が高く，[ネットワークのバインドがうまくいかない場合](#ネットワークのバインドがうまくいかない場合) から読むことを推奨する．

:::

### 原因

通常 DNSサーバー名を記述したファイルは自動で生成される．
しかし，何らかの理由^[Wi-Fi を普段とは異なるものを使用したり，Docker が悪さをしたりなどが考えられる]によりうまく動作していない場合がある．
今回は これが原因だと考え，手動でバインドすることで解決を図る策を次に述べる．
（その為，通常は自動で生成される設定^[```generateResolvConf = true```のこと]にしておくべきである．）

### 解決策１

最も簡単な方法である．

#### `/etc/resolv.conf`の変更

`/etc/resolv.conf`を次の１行に変更する．

```sh:/etc/resolv.conf
nameserver 8.8.8.8
```

これでうまく行かない場合でも，この操作に加えて`wsl --shutdown`などの WSL のシャットダウンを行い再起動すると解決することもよくある．

### 解決策２

前述した[解決策１](#解決策１)の永続化である．

#### 1.`/etc/wsl.conf`への追記

まず，`/etc/wsl.conf`に次の２行を追記する．

```sh:/etc/wsl.conf
[network]
generateResolvConf = false
```

:::message

- 書き込み権限に注意する（`sudo` などする）
- ファイルがない場合は新規作成する
- 既に`[network]`の項目がある場合は，`generateResolvConf = false`のみで良い

:::

#### 2.wslの再起動

PowerShellで次のコマンドを実行すると，任意のディストリビューションをシャットダウンできる．

```sh:posh
wsl --terminate ディストリビューション名
```

その後，いつもの方法で起動する．

:::message

以下で，すべてのディストーション と WSL2簡易ユーティリティ仮想マシン をシャットダウンすることができる．

```sh:posh
wsl --shutdown
```

:::

#### 3.`/etc/resolv.conf`の変更

`/etc/resolv.conf`を次の１行に変更する．

```sh:/etc/resolv.conf
nameserver 8.8.8.8
```

### 補足１

`/etc/wsl.conf`を変更する前に`/etc/resolv.conf`を確認すると，次の記述が見られる

```
# This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
# [network]
# generateResolvConf = false
```

### 補足２

`systemd-resolved` などに書き換えられる場合がある．
このような場合は，

```sh:wsl
sudo unlink /etc/resolv.conf
```

で，シンボリックリンクを削除した上で，`resolv.conf` を作成し，

```sh:wsl
sudo chattr +i /etc/resolv.conf
```

により，変更を禁止すれば良い．
なお，`sudo rm` なども制限されるので，変更を加えたい場合は 先程のコマンドの `+i` を `-i` に変更し，実行すれば良い．

## ネットワークのバインドがうまくいかない場合

この場合は，[前述の場合](#この場合の特徴)とは異なり，`ping 8.8.8.8`なども失敗する．

### 原因

通常 WSL 起動時に，WSL側 のネットワークと Windows側 の仮想ネットワークは自動でバインドされる．
しかし，このバインドがうまく動作していない場合がある．
今回は これが原因だと考え，手動でバインドすることで解決を図る策を次に述べる．

### 解決策１

[wsl2上のLinux　からインターネットにアクセスできない場合の暫定解決策 – 株式会社シーポイントラボ ｜ 浜松のシステム・RTK-GNSS開発](https://cpoint-lab.co.jp/article/202105/19922/)
という記事が参考になる．リンク先がアクセスできなくなる可能性に備え，コマンドは以下に述べておく．

```sh:wsl
sudo ip l set eth0 up
```

### 解決策２

こちらも**同記事**が参考になる: [wsl2上のLinux　からインターネットにアクセスできない場合の暫定解決策](https://cpoint-lab.co.jp/article/202105/19922/)

```sh:wsl
ip route show | grep -i default | awk '{ print $3}'
```

の出力結果が`172.17.224.1`の時，次を実行する（出力結果が異なる場合は自分で数値を書き換える）

```sh:wsl
sudo ip address add 172.17.224.10/20 broadcast 172.17.224.255 dev eth0
sudo ip route add default via 172.17.224.1
```

## ネットワークアダプターが不調の場合

この場合は，[前々述の場合](#この場合の特徴)とは異なり，`ping 8.8.8.8`なども失敗する．

### 原因

今回は ネットワークアダプターの不調が原因だと考え，手動で再起動することで解決を図る策を次に述べる．

### 解決策

管理者権限の付いた PowerShell で以下を実行する．

```sh:posh
Restart-Service LxssManager # WSL Service の再起動

Stop-Service -name "hns"    # Host Network Service の停止
Start-Service -name "hns"   # Host Network Service の起動

Get-NetAdapter -IncludeHidden | Where-Object `
    {$_.InterfaceDescription.StartsWith('Hyper-V Virtual Switch Extension Adapter')} `
    | Disable-NetAdapter -Confirm:$False # Hyper-V adapters の再起動
Get-NetAdapter -IncludeHidden | Where-Object `
    {$_.InterfaceDescription.StartsWith('Hyper-V Virtual Switch Extension Adapter')} `
    | Enable-NetAdapter -Confirm:$False  # Hyper-V adapters の再起動
```

### 補足

`Winキー + i`などで Windows の設定を起動し，
システム > トラブルシューティング > その他のトラブルシューティング > ネットワークとインターネット > Wi-Fi ネットワーク アダプターを再起動します > アダプターを再起動する
からでも再起動できるが，私の環境では効果がなかった場合もあった．

---

# 解決できないとき用の記事

### コマンド

#### WSLのローカルIPアドレス

Windows側 から見るので，PowerShell で実行する．仕組みとしては，WSLの既定に設定されたディストーション上で hostname -I を実行しているだけである．（実質WSL側から見ている）

```sh:posh
wsl hostname -I
```

筆者の環境（ディストーションは Arch Linux）で起こったことだが，`hostname` に `-I` オプションが存在しなかた．
そのような場合，こちらのWindows上で実行した `ipconfig` の結果を `grep` していることに相当するコマンドを用いる．

```sh:posh
Get-NetIPConfiguration -InterfaceAlias "vEthernet (WSL (Hyper-V firewall))" | Select-Object -Property IPv4Address
```

なお，WSL側から見たいのであれば，次のコマンドを使用できる．

```sh:wsl
cat /etc/resolv.conf
```

:::message alert

`wsl hostname` コマンドのオプション．`-i` と `-I` は異なるものである．
`wsl hostname -i`は，ローカルコンピューターのIPアドレス(127.0.1.1 はプレースホルダー診断アドレス)である．
``wsl hostname -I` は，他のマシンから見た ローカルコンピューターのIP アドレスである．
詳しくは，[こちらのMicrosoftによる解説](https://learn.microsoft.com/ja-jp/windows/wsl/networking)を参考にすると良い．

:::

#### WindowsのローカルIPアドレス

WSL側 から見るので，WSL で実行する．

```sh:wsl
ip route show | grep -i default | awk '{ print $3}'
```

#### netshコマンドをWindows側で実行し，WinSocketを再起動する方法

- [\[2023年6月版\]WSLだけ外に出れない？](https://zenn.dev/asopitech/articles/20230621-173203_1)

#### いくつかの知見が集まった質問

- [No internet connection on WSL Ubuntu (Windows Subsystem for Linux) - Stack Overflow](https://stackoverflow.com/questions/62314789/no-internet-connection-on-wsl-ubuntu-windows-subsystem-for-linux/63578387#63578387)

#### WSLのバックアップ

- [WSL 2 の環境をバックアップ＆複製する方法 - LAZE SOFTWARE](https://lazesoftware.com/ja/blog/230206/)
- [WSL上のLinuxのバックアップ](https://www.aise.ics.saitama-u.ac.jp/~gotoh/HowToBackupLinuxOnWSL.html)

#### WSLの再インストール

- [Windows 10とWindows 11でWSLをアンインストールする方法](https://jp.minitool.com/news/uninstall-wsl.html)
- [WSL2の初歩メモ](https://qiita.com/rubytomato@github/items/a290ecef2ea86ea8350f)

#### Microsoftの記事

- [WSL を使用したネットワーク アプリケーションへのアクセス \_ Microsoft Learn](https://learn.microsoft.com/ja-jp/windows/wsl/networking)

#### Hyper-Vとの関係に関する記事

- [WSL2とHyper-Vの関係 #WSL - Qiita](https://qiita.com/matarillo/items/ca1eecf8f9a3cd76f9ce)

#### Windowsのデータを保持して再インストール

:::message
次は，**WSLではなく**，Windowsの再インストールである，
:::

- [Windows を再インストールする - Microsoft サポート](https://support.microsoft.com/ja-jp/windows/windows-%E3%82%92%E5%86%8D%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B-d8369486-3e33-7d9c-dccc-859e2b022fc7) の [インストール メディアを使用してWindows 11を再インストールする すべて保持する (既定)](https://support.microsoft.com/ja-jp/windows/windows-%E3%82%92%E5%86%8D%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B-d8369486-3e33-7d9c-dccc-859e2b022fc7#bkmk_reinstall_windows_10_using_installation_media:~:text=Low-,%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%20%E3%83%A1%E3%83%87%E3%82%A3%E3%82%A2%E3%82%92%E4%BD%BF%E7%94%A8%E3%81%97%E3%81%A6Windows%2011%E3%82%92%E5%86%8D%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B,-%E3%81%99%E3%81%B9%E3%81%A6%E4%BF%9D%E6%8C%81%E3%81%99%E3%82%8B)

---

# 参考文献

## 1

- [WSL2をインストールして使うときの注意点 #Hyper-V - Qiita](https://qiita.com/matarillo/items/98d7452967987fe5d633)

---

# 関連文献

## 関連項目: [命名解決に失敗している場合](#命名解決に失敗している場合)

- [WSLの起動時にresolv.confを再生成されないようにする](https://zenn.dev/ekuinox/articles/520500939e5242a6393c)
- [WSLからインターネットに接続できないときは*etc_resolv.confを変更する * Cosnomi Blog](https://blog.cosnomi.com/posts/wsl-resolv-conf/)
- [WSL2でネットワークに接続できないときの対処法 - うめこの開発日記](https://aniharu.hatenablog.com/entry/2021/11/14/231616)

## 関連項目: [ネットワークのバインドがうまくいかない場合](#ネットワークのバインドがうまくいかない場合)

- [wsl2上のLinux　からインターネットにアクセスできない場合の暫定解決策 – 株式会社シーポイントラボ ｜ 浜松のシステム・RTK-GNSS開発](https://cpoint-lab.co.jp/article/202105/19922/)
- [\[WSL2_Ubuntu_Debian_Kali\] Network not configured · Issue #5286 · microsoft_WSL](https://github.com/microsoft/WSL/issues/5286)

## 関連項目: [ネットワークアダプターが不調の場合](#ネットワークアダプターが不調の場合)

- [WSLでネットワークが不調で外部と通信できないときにやったこと - ✍️blog](https://sabiz.hateblo.jp/entry/2023/05/05/093711)
- [Can't ping failing in both directions after updating to 10.0.20197.0 · Issue #5805 · microsoft_WSL](https://github.com/microsoft/WSL/issues/5805#issuecomment-703734407)
